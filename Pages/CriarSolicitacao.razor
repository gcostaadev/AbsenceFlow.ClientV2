@page "/solicitacoes/novo"
@using AbsenceFlow.ClientV2.Models
@using AbsenceFlow.ClientV2.Enums
@using System.Net.Http.Json
@using System.ComponentModel.DataAnnotations

@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Criar Novo Pedido de Ausência</PageTitle>

<h3 class="mb-4 text-primary">
    <i class="bi bi-calendar-plus me-2"></i> Nova Solicitação
</h3>

<EditForm Model="solicitacaoModel" OnValidSubmit="EnviarSolicitacao">
    <DataAnnotationsValidator />

    <div class="card shadow-sm p-4">

        <!-- ID Colaborador -->
        <div class="form-group mb-3">
            <label class="form-label fw-bold">ID do Colaborador</label>
            <InputNumber class="form-control" @bind-Value="solicitacaoModel.IdColaborador" />
            <ValidationMessage For="@(() => solicitacaoModel.IdColaborador)" class="text-danger" />
        </div>

        <!-- Tipo -->
        <div class="form-group mb-3">
            <label class="form-label fw-bold">Tipo da Solicitação</label>
            <InputSelect class="form-control" @bind-Value="solicitacaoModel.Tipo">
                <option value="">-- Selecione o Tipo --</option>
                @foreach (var item in Enum.GetValues<SolicitacaoTipoEnum>())
                {
                    <option value="@item">@item</option>
                }
            </InputSelect>
            <ValidationMessage For="@(() => solicitacaoModel.Tipo)" class="text-danger" />
        </div>

        <!-- Datas -->
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <label class="form-label fw-bold">Data de Início</label>
                <InputDate class="form-control" @bind-Value="solicitacaoModel.DataInicio" />
                <ValidationMessage For="@(() => solicitacaoModel.DataInicio)" class="text-danger" />
            </div>

            <div class="col-md-6">
                <label class="form-label fw-bold">Data de Fim</label>
                <InputDate class="form-control" @bind-Value="solicitacaoModel.DataFim" />
                <ValidationMessage For="@(() => solicitacaoModel.DataFim)" class="text-danger" />
            </div>
        </div>

        <!-- Motivo -->
        <div class="form-group mb-4">
            <label class="form-label fw-bold">Motivo</label>
            <InputTextArea class="form-control"
                           @bind-Value="solicitacaoModel.Motivo"
                           rows="3"
                           placeholder="Insira o motivo da ausência&hellip;" />
            <ValidationMessage For="@(() => solicitacaoModel.Motivo)" class="text-danger" />
        </div>

        <!-- Ações -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-end border-top pt-3">

            <button class="btn btn-success btn-lg" type="submit" disabled="@isSubmitting">
                @if (isSubmitting)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <span>Enviando...</span>
                }
                else
                {
                    <i class="bi bi-send me-2"></i>
                    <span>Enviar Solicitação</span>
                }
            </button>


            <a href="/solicitacoes" class="btn btn-outline-secondary btn-lg">
                <i class="bi bi-x-circle me-2"></i> Cancelar
            </a>
        </div>
    </div>
</EditForm>

@if (!string.IsNullOrEmpty(feedbackMessage))
{
    <div class="alert @(isSuccess ? "alert-success" : "alert-danger") mt-4" role="alert">
        @feedbackMessage
    </div>
}

@code {

    private SolicitacaoInputModel solicitacaoModel = new();
    private bool isSubmitting = false;
    private string feedbackMessage = string.Empty;
    private bool isSuccess = false;

    private async Task EnviarSolicitacao()
    {
        isSubmitting = true;
        feedbackMessage = string.Empty;

        try
        {
            var response = await Http.PostAsJsonAsync(
                "https://localhost:7230/api/solicitacoes",
                solicitacaoModel);

            if (response.IsSuccessStatusCode)
            {
                feedbackMessage = "Solicitação enviada com sucesso! Redirecionando...";
                isSuccess = true;

                await Task.Delay(1500);
                Navigation.NavigateTo("/solicitacoes");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                feedbackMessage =
                    $"Erro ao enviar solicitação ({(int)response.StatusCode} {response.ReasonPhrase}): {errorContent}";
                isSuccess = false;
                Console.WriteLine(errorContent);
            }
        }
        catch (Exception ex)
        {
            feedbackMessage = $"Erro inesperado: Falha de conexão. {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
