@page "/solicitacoes/revisao/{id:int}"
@using AbsenceFlow.ClientV2.Services
@inject ISolicitacaoApiService SolicitacaoService
@inject IColaboradorApiService ColaboradorService
@inject NavigationManager Navigation

@using AbsenceFlow.ClientV2.Enums
@using AbsenceFlow.ClientV2.Models

<PageTitle>Revisão da Solicitação</PageTitle>

<h3 class="text-primary mb-4">
    <i class="bi bi-pencil-square me-2"></i> Revisão da Solicitação
</h3>

@if (isLoading)
{
    <div class="d-flex justify-content-center p-5">
        <div class="spinner-border text-primary"></div>
    </div>
}
else if (solicitacao == null)
{
    <div class="alert alert-danger">Solicitação não encontrada.</div>
}
else
{
    <div class="card shadow p-4">

        <h5 class="text-secondary mb-3">Informações da Solicitação</h5>

        <div class="row mb-2">
            <div class="col-md-6"><strong>ID:</strong> @solicitacao.Id</div>
            <div class="col-md-6"><strong>Tipo:</strong> @GetTipoDescription(solicitacao.Tipo)</div>
        </div>

        <div class="row mb-2">
            <div class="col-md-6"><strong>Colaborador:</strong> @(colaborador?.NomeCompleto ?? "Não encontrado")</div>
            <div class="col-md-6"><strong>Status Atual:</strong> <span class="@GetStatusBadgeClass(solicitacao.Status)">@GetStatusDescription(solicitacao.Status)</span></div>
        </div>

        <div class="row mb-2">
            <div class="col-md-6"><strong>Data Início:</strong> @solicitacao.DataInicio.ToString("dd/MM/yyyy")</div>
            <div class="col-md-6"><strong>Data Fim:</strong> @solicitacao.DataFim.ToString("dd/MM/yyyy")</div>
        </div>

        <div class="mb-2">
            <strong>Dias Úteis Solicitados:</strong> @solicitacao.DiasUteisSolicitados
        </div>

        @if (!string.IsNullOrEmpty(solicitacao.Motivo))
        {
            <div class="mb-3">
                <strong>Motivo / Justificativa:</strong>
                <p class="text-dark ms-3">@solicitacao.Motivo</p>
            </div>
        }

        <div class="mt-4 d-flex gap-3">
            <button class="btn btn-success" @onclick="Aprovar">
                <i class="bi bi-check-lg me-1"></i> Aprovar
            </button>
            <button class="btn btn-danger" @onclick="Rejeitar">
                <i class="bi bi-x-lg me-1"></i> Rejeitar
            </button>
            <button class="btn btn-secondary" @onclick="Cancelar">
                <i class="bi bi-arrow-left me-1"></i> Cancelar
            </button>
        </div>
    </div>
}

@code {
    [Parameter] public int id { get; set; }

    private bool isLoading = true;
    private SolicitacaoViewModel? solicitacao;
    private ColaboradorViewModel? colaborador;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            solicitacao = await SolicitacaoService.GetSolicitacaoByIdAsync(id);

            if (solicitacao != null)
            {
                colaborador = await ColaboradorService.GetColaboradorByIdAsync(solicitacao.IdColaborador);
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task Aprovar()
    {
        await SolicitacaoService.UpdateStatusAsync(id, SolicitacaoStatusEnum.Aprovada);
        Navigation.NavigateTo("/solicitacoes/lista");
    }

    private async Task Rejeitar()
    {
        await SolicitacaoService.UpdateStatusAsync(id, SolicitacaoStatusEnum.Rejeitada);
        Navigation.NavigateTo("/solicitacoes/lista");
    }

    private void Cancelar()
    {
        Navigation.NavigateTo("/solicitacoes/lista");
    }

    private string GetStatusBadgeClass(SolicitacaoStatusEnum status) => status switch
    {
        SolicitacaoStatusEnum.Pendente => "bg-warning text-dark",
        SolicitacaoStatusEnum.Aprovada => "bg-success",
        SolicitacaoStatusEnum.Rejeitada => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetStatusDescription(SolicitacaoStatusEnum status) => status switch
    {
        SolicitacaoStatusEnum.Pendente => "Pendente",
        SolicitacaoStatusEnum.Aprovada => "Aprovada",
        SolicitacaoStatusEnum.Rejeitada => "Rejeitada",
        _ => "Desconhecido"
    };

    private string GetTipoDescription(SolicitacaoTipoEnum tipo) => tipo switch
    {
        SolicitacaoTipoEnum.Ferias => "Férias",
        SolicitacaoTipoEnum.Ausencia => "Ausência",
        _ => "Desconhecido"
    };
}

